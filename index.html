<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minecraft Server Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }

    .stats {
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 191, 255, 0.3);
      box-shadow: 0 0 30px rgba(0, 191, 255, 0.2);
      border-radius: 20px;
      padding: 25px;
      width: 90%;
      max-width: 420px;
      text-align: center;
      margin-bottom: 30px;
      animation: fadeIn 1s ease-out;
    }

    h2 {
      font-size: 1.8em;
      color: #00e5ff;
      margin-bottom: 20px;
    }

    .stat {
      margin: 10px 0;
      font-size: 1.2em;
    }

    canvas {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 15px;
      padding: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<div class="stats">
  <h2>ðŸŸ¢ Minecraft Server Stats</h2>
  <div class="stat">Online: <span id="online">--</span></div>
  <div class="stat">24h Peak: <span id="peak24h">--</span></div>
  <div class="stat">All-Time Peak: <span id="alltime">--</span></div>
</div>

<canvas id="playerChart" width="400" height="200"></canvas>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBQCpQ0Hpze2o1iqPHzDl-yfYWQAeohSGQ",
    authDomain: "mc-server-stats-c9e35.firebaseapp.com",
    databaseURL: "https://mc-server-stats-c9e35-default-rtdb.firebaseio.com",
    projectId: "mc-server-stats-c9e35",
    storageBucket: "mc-server-stats-c9e35.appspot.com",
    messagingSenderId: "843071322483",
    appId: "1:843071322483:web:094c645a3fa167cfcb2d06"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const API_URL = 'https://api.mcstatus.io/v2/status/java/185.246.211.231:17708';

  const chartLabels = [];
  const chartData = [];

  const ctx = document.getElementById('playerChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: chartLabels,
      datasets: [{
        label: 'Online Players',
        data: chartData,
        fill: true,
        borderColor: '#00bfff',
        backgroundColor: 'rgba(0, 191, 255, 0.1)',
        tension: 0.3,
        pointRadius: 3,
        pointBackgroundColor: '#00e5ff',
      }]
    },
    options: {
      scales: {
        x: {
          ticks: { color: '#ccc' }
        },
        y: {
          beginAtZero: true,
          ticks: { color: '#ccc' }
        }
      },
      plugins: {
        legend: {
          labels: { color: '#eee' }
        }
      }
    }
  });

  async function fetchStats() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      const online = data.players.online || 0;
      const now = Date.now();

      document.getElementById('online').textContent = online;

      // Peak updates
      const snapshot = await db.ref('/stats').once('value');
      let stats = snapshot.val() || { peak24h: 0, alltime: 0, timestamp: 0 };

      if (now - stats.timestamp > 24 * 60 * 60 * 1000) {
        stats.peak24h = online;
        stats.timestamp = now;
      } else if (online > stats.peak24h) {
        stats.peak24h = online;
      }

      if (online > stats.alltime) {
        stats.alltime = online;
      }

      await db.ref('/stats').set(stats);

      document.getElementById('peak24h').textContent = stats.peak24h;
      document.getElementById('alltime').textContent = stats.alltime;

      // Save time-series data
      const entry = {
        timestamp: now,
        online: online
      };
      await db.ref(`/history/${now}`).set(entry);

      cleanupOldEntries(); // Optional cleanup of >5min old data

      updateChart(); // Refresh chart with latest history

    } catch (e) {
      console.error('Error fetching stats:', e);
    }
  }

  async function updateChart() {
    const now = Date.now();
    const fiveMinAgo = now - 5 * 60 * 1000;

    const snapshot = await db.ref('/history').orderByKey().startAt(fiveMinAgo.toString()).once('value');
    const values = snapshot.val() || {};

    chartLabels.length = 0;
    chartData.length = 0;

    Object.values(values).forEach(entry => {
      const time = new Date(entry.timestamp).toLocaleTimeString();
      chartLabels.push(time);
      chartData.push(entry.online);
    });

    chart.update();
  }

  // Remove entries older than 10 minutes to save space
  async function cleanupOldEntries() {
    const cutoff = Date.now() - 10 * 60 * 1000;
    const snapshot = await db.ref('/history').orderByKey().endAt(cutoff.toString()).once('value');
    const oldEntries = snapshot.val() || {};

    const updates = {};
    for (const key in oldEntries) {
      updates[key] = null;
    }
    await db.ref('/history').update(updates);
  }

  updateChart();
  fetchStats();
  setInterval(fetchStats, 10000); // Every 10s
</script>

</body>
</html>

